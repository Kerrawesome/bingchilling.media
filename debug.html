<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://em-content.zobj.net/source/google/387/soft-ice-cream_1f366.png" type="image/png">
    <title>PressReader Tools</title>
    <style>
        .token-output,
        .api-output {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #linksContainer {
            word-wrap: break-word;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            overflow-y: visible;
            max-height: none;
            position: relative;
            display: none;
        }

        #loadingIndicator {
            display: none;
        }

        .code-style {
            font-family: monospace;
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .checkbox-with-padding {
            margin-left: 10px;
        }

        #readerContainer {
            display: none;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 100vw;
            overflow-x: auto;
            padding-top: 10px;
        }

        #readerImage {
            width: 100%;
            height: auto;
        }

        input[type="number"] {
            width: 60px;
        }

        #pageIndicator {
            width: 80px;
        }

        .controls-container {
            display: none;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .dynamic-width-input {
            width: auto;
            min-width: 50px;
        }

        .dropdown {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>PressReader Tools</h1>
    <h3>By Kerrawesome</h3>
    <p>These tools are for educational purposes only.<br>All content displayed is copyright and remains the property of PressReader Inc.</p>

    <label for="cidDropdown">Select CID:</label>
    <select id="cidDropdown" name="cidDropdown" class="dropdown">
        <option value="" selected disabled hidden>Select a CID</option>
        <option value="1126">1126 The New Zealand Herald [Mon-Fri]</option>
        <option value="7478">7478 The Weekend Herald [Sat]</option>
        <option value="1211">1211 The Herald on Sunday [Sun]</option>
        <option value="1759">1759 Western Leader [Thu]</option>
        <option value="9658">9658 NZ House & Garden [Monthly]</option>
        <option value="custom">Custom CID</option>
    </select>
    <input type="text" id="cid" name="cid" class="dynamic-width-input" style="display: none;" placeholder="" oninput="adjustInputWidth(this)"><br><br>

    <label for="issueDate">Issue Date:</label>
    <input type="date" id="issueDate" name="issueDate"><br>

    <label for="issueSuffixDropdown">Issue Suffix:</label>
    <select id="issueSuffixDropdown" name="issueSuffixDropdown" class="dropdown">
        <option value="00000000001001">00000000001001 (default)</option>
        <option value="00000051001001">00000051001001</option>
        <option value="custom">Custom Issue Suffix</option>
    </select>
    <input type="text" id="issueSuffix" name="issueSuffix" value="00000000001001" class="dynamic-width-input" style="display: none;" placeholder="" oninput="adjustInputWidth(this)"><br><br>

    <button id="directReaderButton">Reader</button>

    <h2>Advanced Tools</h2>
    <button id="fetchIssueInfo">Issue Info</button>
    <button id="fetchCatalog">Catalog</button>
    <button id="fetchPages">Fetch Pages</button>

    <h2 id="tokenHeader" style="display:none;">Bearer Token</h2>
    <pre id="tokenOutput" class="token-output"></pre>

    <h2 id="accessTokenHeader" style="display:none;">Access Tokens</h2>
    <pre id="accessTokenOutput" class="token-output"></pre>

    <h2>API Output</h2>
    <pre id="output" class="api-output"></pre>

    <div id="qualitySelectorContainer" class="dropdown" style="display:none;">
        <label for="qualitySelector">Quality:</label>
        <select id="qualitySelector" name="qualitySelector">
            <option disabled>Standard</option>
            <option value="&width=1368">Width: 1368</option>
            <option value="&height=2448">Height: 2448</option>
            <option disabled>High Quality</option>
            <option value="&width=2060">Width: 2060</option>
            <option value="&height=2884">Height: 2884</option>
			<option value="custom">Custom Size</option>
        </select>
    </div>

    <div id="checkMessage"></div>
    <div id="loadingIndicator">Loading...</div>

    <div id="readerButtonContainer" class="controls-container">
        <input type="checkbox" id="getPngCheckbox" class="checkbox-with-padding">
        <label for="getPngCheckbox">Get as <span class="code-style">.png</span></label>
        <span id="resolutionLabel" class="code-style" style="display:none;"></span>
    </div>

    <div id="readerControls" class="controls-container">
        <button id="prevPage">Previous</button>
        <input type="number" id="pageIndicator" class="dynamic-width-input" min="1">
        <span id="totalPages"></span>
        <button id="nextPage">Next</button>
    </div>

    <div id="linksContainer"></div>

    <div id="readerContainer">
        <img id="readerImage" src="" alt="Reader Image">
    </div>

    <script>
        const primaryAccessToken = '_C6WK4jD09pQHoU7WOZG-EBYjytNutTUwP6umGmBEm5I06heGAxOZKSs39GFJrAEsAQ0FSfMX6IiBC4hJPWLMvqX_cmsCDLTdhQIqy8Z-Vs!';
        const secondaryAccessToken = '7lykuJZcSDUnlAxrCh89oET_SIwEwQK3jDRuibpFI8yb2aKadg_W2LSSlf8kO6EDFFBpcejU9ANbN59GiAQlV9sjVMeMTSyFafYCK6beouM!';
        let bearerToken = '';
        let pageUrls = [];
        let currentPage = 1;

        const cidToScaleMap = {
            "1126": "&width=2060", // The New Zealand Herald [Mon-Fri]
            "1211": "&width=2060", // The Herald on Sunday [Sun]
            "9658": "&height=2884", // NZ House & Garden [Monthly]
            "7478": "&height=2448", // The Weekend Herald [Sat]
            "1759": "&height=2448" // Western Leader [Thu]
        };

        function adjustInputWidth(input) {
            input.style.width = (input.value.length + 1) + 'ch';
        }

        function clearOutputs() {
            document.getElementById('tokenOutput').textContent = '';
            document.getElementById('accessTokenOutput').textContent = '';
            document.getElementById('output').textContent = '';
            document.getElementById('linksContainer').innerHTML = '';
            document.getElementById('tokenHeader').style.display = 'none';
            document.getElementById('accessTokenHeader').style.display = 'none';
            document.getElementById('qualitySelectorContainer').style.display = 'none';
            document.getElementById('checkMessage').textContent = '';
            document.getElementById('readerContainer').style.display = 'none';
            document.getElementById('readerControls').style.display = 'none';
            document.getElementById('readerButtonContainer').style.display = 'none';
            document.getElementById('resolutionLabel').style.display = 'none';
            document.getElementById('getPngCheckbox').style.display = 'inline';
            document.querySelector('label[for="getPngCheckbox"]').style.display = 'inline';
        }

        function formatDateToYYYYMMDD(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function updateQualitySelector(cid) {
            const qualitySelector = document.getElementById('qualitySelector');
            if (cidToScaleMap[cid]) {
                qualitySelector.value = cidToScaleMap[cid];
            } else {
                qualitySelector.value = "&width=1368"; // Default option if no match is found
            }
        }

        async function fetchBearerToken() {
            try {
                const response = await fetch('https://www.pressreader.com/authentication/v1/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                document.getElementById('tokenOutput').textContent = JSON.stringify(data, null, 2);
                bearerToken = data.bearerToken;

                if (!bearerToken) {
                    throw new Error('Bearer token is missing in the response');
                }
                document.getElementById('tokenHeader').style.display = 'block';
            } catch (error) {
                document.getElementById('tokenOutput').textContent = `Error: ${error.message}`;
                console.error('Error fetching bearer token:', error);
            }
        }

        async function makeApiRequest(url) {
            const headers = {
                "Accept": "*/*",
                "Authorization": `Bearer ${bearerToken}`
            };

            try {
                const response = await fetch(url, { headers });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('output').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('output').textContent = `Error: ${error.message}`;
                console.error('Error fetching API data:', error);
            }
        }

        async function fetchPageKeys(accessToken, cid, issueDate, issueSuffix) {
            const formattedDate = formatDateToYYYYMMDD(issueDate);
            const url = `https://ingress.pressreader.com/services/IssueInfo/GetPageKeys?accessToken=${accessToken}&issue=${cid}${formattedDate}${issueSuffix}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                return data.PageKeys;
            } catch (error) {
                console.error('Error fetching page keys:', error);
                return null;
            }
        }

        async function fetchAndDisplayPages(cid, issueDate, issueSuffix, pageKeys) {
            const formattedDate = formatDateToYYYYMMDD(issueDate);
            const issueId = `${cid}${formattedDate}${issueSuffix}`;
            const selectedQuality = document.getElementById('qualitySelector').value;

            pageUrls = pageKeys.map(page => {
                const pageNumber = page.PageNumber;
                const pageKey = page.Key;
                return {
                    originalUrl: `https://i.prcdn.co/img?file=${issueId}&page=${pageNumber}&ticket=${pageKey}`,
                    pageNumber: pageNumber
                };
            });

            updatePageUrls(selectedQuality);
            document.getElementById('qualitySelectorContainer').style.display = 'block';
            document.getElementById('readerButtonContainer').style.display = 'flex';
        }

        function updatePageUrls(selectedQuality) {
            pageUrls.forEach(page => {
                page.currentUrl = `${page.originalUrl}${selectedQuality}${document.getElementById('getPngCheckbox').checked ? '&format=png' : ''}`;
            });
            updatePageLinks();
        }

        function updatePageLinks() {
            const pageLinksHtml = pageUrls.map(page => `<a href="${page.currentUrl}" target="_blank">${page.currentUrl}</a>`).join('<br>');
            document.getElementById('linksContainer').innerHTML = pageLinksHtml;
            loadPage(currentPage);
        }

        function showReader() {
            document.getElementById('linksContainer').style.display = 'none';
            document.getElementById('readerContainer').style.display = 'block';
            document.getElementById('readerControls').style.display = 'flex';
            // Hide the checkbox and label
            document.getElementById('getPngCheckbox').style.display = 'none';
            document.querySelector('label[for="getPngCheckbox"]').style.display = 'none';
            document.getElementById('resolutionLabel').style.display = 'inline';
            loadPage(currentPage);
        }

        function loadPage(pageNumber) {
            const selectedPage = pageUrls.find(page => page.pageNumber === pageNumber);
            if (selectedPage) {
                document.getElementById('readerImage').src = selectedPage.currentUrl;
                document.getElementById('pageIndicator').value = pageNumber;
                document.getElementById('totalPages').textContent = ` / ${pageUrls.length}`;

                // Display current resolution in the reader
                const img = new Image();
                img.src = selectedPage.currentUrl;
                img.onload = function () {
                    document.getElementById('resolutionLabel').textContent = `${img.width} x ${img.height}`;
                    document.getElementById('resolutionLabel').style.display = 'inline';
                };
            }
        }

        document.getElementById('cidDropdown').addEventListener('change', () => {
            const cidDropdown = document.getElementById('cidDropdown');
            const cidInput = document.getElementById('cid');
            const selectedCid = cidDropdown.value;

            if (selectedCid === 'custom') {
                cidInput.style.display = 'inline';
            } else {
                cidInput.style.display = 'none';
            }

            // Update quality based on CID selection
            updateQualitySelector(selectedCid);
        });

        document.getElementById('issueSuffixDropdown').addEventListener('change', () => {
            const issueSuffixDropdown = document.getElementById('issueSuffixDropdown');
            const issueSuffixInput = document.getElementById('issueSuffix');
            if (issueSuffixDropdown.value === 'custom') {
                issueSuffixInput.style.display = 'inline';
            } else {
                issueSuffixInput.style.display = 'none';
                issueSuffixInput.value = issueSuffixDropdown.value;
            }
        });

        document.getElementById('directReaderButton').addEventListener('click', async () => {
            clearOutputs();
            document.getElementById('linksContainer').style.display = 'none';
            document.getElementById('readerControls').style.display = 'none';
            const cidDropdown = document.getElementById('cidDropdown');
            const cid = cidDropdown.value === 'custom' ? document.getElementById('cid').value : cidDropdown.value;
            const issueDate = document.getElementById('issueDate').value;
            const issueSuffix = document.getElementById('issueSuffix').value;

            if (!cid || !issueDate || !issueSuffix) {
                alert('Please enter CID, Issue Date, and Issue Suffix');
                return;
            }

            let pageKeys = await fetchPageKeys(primaryAccessToken, cid, issueDate, issueSuffix);

            if (!pageKeys || pageKeys.length === 0) {
                pageKeys = await fetchPageKeys(secondaryAccessToken, cid, issueDate, issueSuffix);
            }

            if (pageKeys && pageKeys.length > 0) {
                await fetchAndDisplayPages(cid, issueDate, issueSuffix, pageKeys);
                showReader();
            } else {
                alert('Failed to fetch page keys with both primary and secondary access tokens');
            }
        });

        document.getElementById('fetchIssueInfo').addEventListener('click', async () => {
            clearOutputs();
            await fetchBearerToken();
            const cidDropdown = document.getElementById('cidDropdown');
            const cid = cidDropdown.value === 'custom' ? document.getElementById('cid').value : cidDropdown.value;
            const issueDate = document.getElementById('issueDate').value;

            let url;

            if (cid) {
                if (issueDate) {
                    url = `https://ingress.pressreader.com/services/IssueInfo/GetIssueInfoByCid?cid=${cid}&issueDate=${formatDateToYYYYMMDD(issueDate)}`;
                } else {
                    url = `https://ingress.pressreader.com/services/IssueInfo/GetIssueInfoByCid?cid=${cid}`;
                }
                await makeApiRequest(url);
            } else {
                alert('Please enter CID');
            }
        });

        document.getElementById('fetchCatalog').addEventListener('click', async () => {
            clearOutputs();
            await fetchBearerToken();
            const url = `https://ingress.pressreader.com/services/catalog`;
            await makeApiRequest(url);
        });

        document.getElementById('fetchPages').addEventListener('click', async () => {
            clearOutputs();
            document.getElementById('linksContainer').style.display = 'block';
            document.getElementById('readerControls').style.display = 'none';
            const cidDropdown = document.getElementById('cidDropdown');
            const cid = cidDropdown.value === 'custom' ? document.getElementById('cid').value : cidDropdown.value;
            const issueDate = document.getElementById('issueDate').value;
            const issueSuffix = document.getElementById('issueSuffix').value;

            if (!cid || !issueDate || !issueSuffix) {
                alert('Please enter CID, Issue Date, and Issue Suffix');
                return;
            }

            let pageKeys = await fetchPageKeys(primaryAccessToken, cid, issueDate, issueSuffix);

            if (!pageKeys || pageKeys.length === 0) {
                pageKeys = await fetchPageKeys(secondaryAccessToken, cid, issueDate, issueSuffix);
            }

            if (pageKeys && pageKeys.length > 0) {
                await fetchAndDisplayPages(cid, issueDate, issueSuffix, pageKeys);
            } else {
                alert('Failed to fetch page keys with both primary and secondary access tokens');
            }
        });

        document.getElementById('qualitySelector').addEventListener('change', () => {
            updatePageUrls(document.getElementById('qualitySelector').value);
        });

        document.getElementById('getPngCheckbox').addEventListener('change', () => {
            updatePageUrls(document.getElementById('qualitySelector').value);
        });

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadPage(currentPage);
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage < pageUrls.length) {
                currentPage++;
                loadPage(currentPage);
            }
        });

        document.getElementById('pageIndicator').addEventListener('input', (event) => {
            const inputPage = parseInt(event.target.value, 10);
            if (inputPage >= 1 && inputPage <= pageUrls.length) {
                currentPage = inputPage;
                loadPage(currentPage);
            }
        });

        document.querySelectorAll('.dynamic-width-input').forEach(input => adjustInputWidth(input));

        // Listen for changes on the quality dropdown and reload reader if open
        document.getElementById('qualitySelector').addEventListener('change', () => {
            updatePageUrls(document.getElementById('qualitySelector').value);
            if (document.getElementById('readerContainer').style.display === 'block') {
                loadPage(currentPage);
            }
        });
    </script>
</body>

</html>
